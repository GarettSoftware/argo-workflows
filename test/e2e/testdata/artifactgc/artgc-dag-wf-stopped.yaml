apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: artgc-dag-wf-stopped-
spec:
  workflowMetadata:
    labels:
      workflows.argoproj.io/test: "true"
  artifactGC:
    serviceAccountName: default
    strategy: OnWorkflowDeletion
  entrypoint: artgc-dag-wf-stopped-main
  serviceAccountName: argo
  executor:
    serviceAccountName: default
  volumeClaimTemplates:
    - metadata:
        name: artifacts
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 1Gi
  # How long to keep workflows around after they have completed https://argoproj.github.io/argo-workflows/fields/#ttlstrategy
  # ttlStrategy:
  #   # 30 seconds
  #   secondsAfterCompletion: 30
  #   secondsAfterSuccess: 30
  #   secondsAfterFailure: 30
  # podGC:
  #   deleteDelayDuration: 15s
  #   strategy: "OnWorkflowCompletion"
  templates:
    - name: artgc-dag-wf-stopped-main
      dag:
        tasks:
          - name: create-artifact
            template: artgc-dag-artifact-creator
          - name: delay-stop-workflow
            template: artgc-dag-delay-stop
          - name: stop-workflow
            template: artgc-dag-workflow-stopper
            dependencies: [delay-stop-workflow]
    - name: artgc-dag-delay-stop
      container:
        image: alpine:latest
        volumeMounts:
          - name: artifacts
            mountPath: /mnt/vol
        command: [sh, -c]
        args:
          - |
            echo "Delaying workflow stop"
            ls /mnt
            x=0
            while [ $x -le 60 ]
            do
              sleep 1
              if test -f "/mnt/vol/test.txt"; then
                echo "Artifact found in shared volume"
                break
              fi
              x=$(( $x + 1 ))
            done
    - name: artgc-dag-workflow-stopper
      container:
        image: argoproj/argocli:latest
        args: 
          - stop
          - -l
          - workflows.argoproj.io/test=true
          - --namespace=argo
          - --loglevel=debug
    - name: artgc-dag-artifact-creator
      container:
        image: alpine:latest
        volumeMounts:
          - name: artifacts
            mountPath: /mnt/vol
        command: [sh, -c]
        args:
          - |
            echo 'testing' > /mnt/vol/test.txt
            echo "Artifact saved to /mnt/vol/test.txt"
            while true
            do
              sleep 1
            done
      outputs:
        artifacts:
          - name: on-deletion-wf-stopped
            path: /mnt/vol/test.txt
            s3:
              key: on-deletion-wf-stopped
              bucket: my-bucket-3
              endpoint: minio:9000
              insecure: true
              accessKeySecret:
                name: my-minio-cred
                key: accesskey
              secretKeySecret:
                name: my-minio-cred
                key: secretkey
            artifactGC:
              strategy: OnWorkflowDeletion